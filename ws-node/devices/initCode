console.log("Initializing..."),global.evalRemoteScript=function(callback){if("connected"===wifi.getStatus().station)let httpClientReq=http.get(initJSON.INIT,function(res){let contents="";res.on("data",function(e){contents+=e}),res.on("close",function(){let result=eval(contents);callback&&callback(result),delete result,delete contents,delete httpClientReq})}).on("error",function(e){console.log("ERROR:",e),delete httpClientReq,"connected"===wifi.getStatus().station&&(console.log("WebSocket Client will retry in 30 seconds..."),setTimeout(evalRemoteScript,3e4,callback))})},global.createWebSocket=function(){"undefined"!=typeof wsServer&&(wsServer.close(),delete wsServer),global.wsServer=require("ws").createServer(function(req,res){if("function"==typeof httpHandle)httpHandle(req,res);else{let reqUrl=url.parse(req.url,!0);if("/"===reqUrl.pathname)res.writeHead(200,{"Content-Type":"text/html"}),res.end(require("Storage").read("httpPage").replace("{HOST_NAME}",initJSON.HOST_NAME));else if("/favicon.ico"===reqUrl.pathname)res.writeHead(200,{"Content-Type":"image/x-icon"}),res.end(require("Storage").read("favicon"));else if("/command"===reqUrl.pathname){res.writeHead(200,{"Content-Type":"text/plain"});let result="";try{reqUrl.query&&reqUrl.query.eval&&(result=eval(reqUrl.query.eval))}catch(e){result=e.msg}res.end(JSON.stringify(result)),delete result}else res.writeHead(404,{"Content-Type":"text/plain"}),res.end("Cannot GET "+reqUrl.pathname);delete reqUrl}}),wsServer.on("websocket",function(ws){ws.on("message",function(message){let msgJSON;try{msgJSON=JSON.parse(message),msgJSON.device===initJSON.HOST_NAME&&(msgJSON.message=eval(msgJSON.message),this.send(JSON.stringify(msgJSON)))}catch(e){this.send(JSON.stringify({device:initJSON.HOST_NAME,message:e.msg}))}finally{delete msgJSON}}),ws.send(JSON.stringify({device:initJSON.HOST_NAME,message:"OK"})),console.log("WebSocket Client connected.")}),wsServer.listen(80),console.log("WebSocket Server ready.")},global.initJSON=require("Storage").readJSON("initJSON"),global.wifi=require("Wifi"),global.http=require("http"),Modules.addCached("ws",require("Storage").read("wsModule")),global.connectWifi=function(e){global.isConnecting=!0,wifi.disconnect(function(){wifi.stopAP(function(){e?(console.log("Access Point Starting..."),wifi.startAP(initJSON.AP_SSID,{password:initJSON.AP_PASSWORD},function(e){e?(console.log("ERROR:",e),wifi.stopAP()):(console.log("Access Point ready."),createWebSocket()),console.log("The system will reset in 60 seconds..."),setTimeout(reset,6e4),delete isConnecting})):(console.log("Station Connecting..."),wifi.connect(initJSON.STA_SSID,{password:initJSON.STA_PASSWORD},function(e){e?(console.log("ERROR:",e),console.log("The system will start access point in 60 seconds..."),setTimeout(connectWifi,6e4,!0)):console.log("Station ready."),delete isConnecting}))})})},wifi.on("connected",function(e){console.log("Station Connected."),console.log(e),delete isConnecting,createWebSocket(),evalRemoteScript(function(e){console.log(e)})}),wifi.on("disconnected",function(e){console.log("Station Disconnected."),console.log(e),"undefined"!=typeof wsServer&&(wsServer.close(),delete wsServer),"undefined"==typeof isConnecting&&(console.log("The system will start station in 60 seconds..."),setTimeout(connectWifi,6e4))}),connectWifi();