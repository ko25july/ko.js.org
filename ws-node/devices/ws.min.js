function WebSocket(e,t){this.socket=null,t=t||{},this.host=e,this.port=t.port||80,this.protocolVersion=t.protocolVersion||13,this.origin=t.origin||"Espruino",this.keepAlive=1e3*t.keepAlive||6e4,this.masking=void 0===t.masking||t.masking,this.path=t.path||"/",this.lastData="",this.connected=t.connected||!1,this.headers=t.headers||{},t.protocol&&(this.protocol=t.protocol);var o=btoa(Math.random().toString(36).substr(2,18));this.key={source:o,hashed:btoa(require("crypto").SHA1(o+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"))}}WebSocket.prototype.initializeConnection=function(){require("net").connect({host:this.host,port:this.port},this.onConnect.bind(this))},WebSocket.prototype.onConnect=function(e){this.socket=e;var t=this;e.on("data",this.parseData.bind(this)),e.on("close",function(){t.pingTimer&&(clearInterval(t.pingTimer),t.pingTimer=void 0),t.emit("close")}),this.handshake()},WebSocket.prototype.parseData=function(e){var t=this;if(this.emit("rawData",e),this.lastData.length&&(e=this.lastData+e,this.lastData=""),!this.connected)return e.indexOf(this.key.hashed)>-1&&e.indexOf("\r\n\r\n")>-1&&(this.emit("handshake"),this.pingTimer=setInterval(function(){t.send("ping",137)},this.keepAlive),e=e.substring(e.indexOf("\r\n\r\n")+4),this.connected=!0,this.emit("open")),void(this.lastData=e);for(;e.length;){var o=2,i=15&e.charCodeAt(0),r=127&e.charCodeAt(1);if(126==r)r=e.charCodeAt(3)|e.charCodeAt(2)<<8,o+=2;else if(127==r)throw"Messages > 65535 in length unsupported";var n=r+o+(128&e.charCodeAt(1)?4:0);if(n>e.length)return void(this.lastData=e);switch(i){case 10:this.emit("pong");break;case 9:this.send("pong",138),this.emit("ping");break;case 8:this.socket.end();break;case 0:case 1:var s=[0,0,0,0];128&e.charCodeAt(1)&&(s=[e.charCodeAt(o++),e.charCodeAt(o++),e.charCodeAt(o++),e.charCodeAt(o++)]);for(var a="",h=0;h<r;h++)a+=String.fromCharCode(e.charCodeAt(o++)^s[3&h]);this.emit("message",a);break;default:console.log("WS: Unknown opcode "+i)}e=e.substr(n)}},WebSocket.prototype.handshake=function(){var e=["GET "+this.path+" HTTP/1.1","Host: "+this.host,"Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Key: "+this.key.source,"Sec-WebSocket-Version: "+this.protocolVersion,"Origin: "+this.origin];for(var t in this.protocol&&e.push("Sec-WebSocket-Protocol: "+this.protocol),this.headers)this.headers.hasOwnProperty(t)&&e.push(t+": "+this.headers[t]);this.socket.write(e.join("\r\n")+"\r\n\r\n")},WebSocket.prototype.send=function(e,t){t=void 0===t?129:t;var o=e.length;if(e.length>125&&(o=126),this.socket.write(String.fromCharCode(t,o+(this.masking?128:0))),126==o&&(this.socket.write(String.fromCharCode(e.length>>8)),this.socket.write(String.fromCharCode(e.length))),this.masking){for(var i=[],r="",n=0;n<4;n++){var s=Math.floor(255*Math.random());i[n]=s,r+=String.fromCharCode(s)}for(var a=0;a<e.length;a++)r+=String.fromCharCode(e.charCodeAt(a)^i[3&a]);this.socket.write(r)}else this.socket.write(e)},WebSocket.prototype.close=function(){this.socket.end()},exports=function(e,t){var o=new WebSocket(e,t);return o.initializeConnection(),o},exports.createServer=function(e){var t=require("http").createServer(function(o,i){if(o.headers.Connection&&o.headers.Connection.indexOf("Upgrade")>=0){var r=o.headers["Sec-WebSocket-Key"],n={Upgrade:"websocket",Connection:"Upgrade","Sec-WebSocket-Accept":btoa(E.toString(require("crypto").SHA1(r+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11")))};o.headers["Sec-WebSocket-Protocol"]&&(n["Sec-WebSocket-Protocol"]=o.headers["Sec-WebSocket-Protocol"]),i.writeHead(101,n);var s=new WebSocket(void 0,{masking:!1,connected:!0});s.socket=i,o.on("data",s.parseData.bind(s)),o.on("close",function(){clearInterval(s.srvPing),s.srvPing=void 0,s.emit("close")}),s.srvPing=setInterval(function(){s.emit("ping",!0),s.send("ping",137)},s.keepAlive),t.emit("websocket",s)}else e(o,i)});return t};