E.setBootCode("clearInterval();clearTimeout();setTimeout(function(){eval(require(\"Storage\").read(\"initCode\"));},3000);", true);

require("Storage").write("initJSON", JSON.stringify({ "HOST_NAME": "ESP_7055E7", "AP_SSID": "ESP_7055E7", "AP_PASSWORD": "", "STA_SSID": "3BB_Chaiwat", "STA_PASSWORD": "0856733368", "INIT": "https://ws-node.herokuapp.com/ESP_7055E7" }));

require("Storage").write("initCode", "console.log(\"Initializing...\"),global.evalRemoteScript=function(callback){if(\"connected\"===wifi.getStatus().station)let httpClientReq=http.get(initJSON.INIT,function(res){let contents=\"\";res.on(\"data\",function(e){contents+=e}),res.on(\"close\",function(){let result=eval(contents);callback&&callback(result),delete result,delete contents,delete httpClientReq})}).on(\"error\",function(e){console.log(\"ERROR:\",e),delete httpClientReq,\"connected\"===wifi.getStatus().station&&(console.log(\"WebSocket Client will retry in 30 seconds...\"),setTimeout(evalRemoteScript,3e4,callback))})},global.createWebSocket=function(){\"undefined\"!=typeof wsServer&&(wsServer.close(),delete wsServer),global.wsServer=require(\"ws\").createServer(function(req,res){if(\"function\"==typeof httpHandle)httpHandle(req,res);else{let reqUrl=url.parse(req.url,!0);if(\"/\"===reqUrl.pathname)res.writeHead(200,{\"Content-Type\":\"text/html\"}),res.end(require(\"Storage\").read(\"httpPage\").replace(\"{HOST_NAME}\",initJSON.HOST_NAME));else if(\"/favicon.ico\"===reqUrl.pathname)res.writeHead(200,{\"Content-Type\":\"image/x-icon\"}),res.end(require(\"Storage\").read(\"favicon\"));else if(\"/command\"===reqUrl.pathname){res.writeHead(200,{\"Content-Type\":\"text/plain\"});let result=\"\";try{reqUrl.query&&reqUrl.query.eval&&(result=eval(reqUrl.query.eval))}catch(e){result=e.msg}res.end(JSON.stringify(result)),delete result}else res.writeHead(404,{\"Content-Type\":\"text/plain\"}),res.end(\"Cannot GET \"+reqUrl.pathname);delete reqUrl}}),wsServer.on(\"websocket\",function(ws){ws.on(\"message\",function(message){let msgJSON;try{msgJSON=JSON.parse(message),msgJSON.device===initJSON.HOST_NAME&&(msgJSON.message=eval(msgJSON.message),this.send(JSON.stringify(msgJSON)))}catch(e){this.send(JSON.stringify({device:initJSON.HOST_NAME,message:e.msg}))}finally{delete msgJSON}}),ws.send(JSON.stringify({device:initJSON.HOST_NAME,message:\"OK\"})),console.log(\"WebSocket Client connected.\")}),wsServer.listen(80),console.log(\"WebSocket Server ready.\")},global.initJSON=require(\"Storage\").readJSON(\"initJSON\"),global.wifi=require(\"Wifi\"),global.http=require(\"http\"),Modules.addCached(\"ws\",require(\"Storage\").read(\"wsModule\")),global.connectWifi=function(e){global.isConnecting=!0,wifi.disconnect(function(){wifi.stopAP(function(){e?(console.log(\"Access Point Starting...\"),wifi.startAP(initJSON.AP_SSID,{password:initJSON.AP_PASSWORD},function(e){e?(console.log(\"ERROR:\",e),wifi.stopAP()):(console.log(\"Access Point ready.\"),createWebSocket()),console.log(\"The system will reset in 60 seconds...\"),setTimeout(reset,6e4),delete isConnecting})):(console.log(\"Station Connecting...\"),wifi.connect(initJSON.STA_SSID,{password:initJSON.STA_PASSWORD},function(e){e?(console.log(\"ERROR:\",e),console.log(\"The system will start access point in 60 seconds...\"),setTimeout(connectWifi,6e4,!0)):console.log(\"Station ready.\"),delete isConnecting}))})})},wifi.on(\"connected\",function(e){console.log(\"Station Connected.\"),console.log(e),delete isConnecting,createWebSocket(),evalRemoteScript(function(e){console.log(e)})}),wifi.on(\"disconnected\",function(e){console.log(\"Station Disconnected.\"),console.log(e),\"undefined\"!=typeof wsServer&&(wsServer.close(),delete wsServer),\"undefined\"==typeof isConnecting&&(console.log(\"The system will start station in 60 seconds...\"),setTimeout(connectWifi,6e4))}),connectWifi();");

require("Storage").write("wsModule", "function WebSocket(e,t){this.socket=null,t=t||{},this.host=e,this.port=t.port||80,this.protocolVersion=t.protocolVersion||13,this.origin=t.origin||\"Espruino\",this.keepAlive=1e3*t.keepAlive||6e4,this.masking=void 0===t.masking||t.masking,this.path=t.path||\"/\",this.lastData=\"\",this.connected=t.connected||!1,this.headers=t.headers||{},t.protocol&&(this.protocol=t.protocol);var o=btoa(Math.random().toString(36).substr(2,18));this.key={source:o,hashed:btoa(require(\"crypto\").SHA1(o+\"258EAFA5-E914-47DA-95CA-C5AB0DC85B11\"))}}WebSocket.prototype.initializeConnection=function(){require(\"net\").connect({host:this.host,port:this.port},this.onConnect.bind(this))},WebSocket.prototype.onConnect=function(e){this.socket=e;var t=this;e.on(\"data\",this.parseData.bind(this)),e.on(\"close\",function(){t.pingTimer&&(clearInterval(t.pingTimer),t.pingTimer=void 0),t.emit(\"close\")}),this.handshake()},WebSocket.prototype.parseData=function(e){var t=this;if(this.emit(\"rawData\",e),this.lastData.length&&(e=this.lastData+e,this.lastData=\"\"),!this.connected)return e.indexOf(this.key.hashed)>-1&&e.indexOf(\"\\r\\n\\r\\n\")>-1&&(this.emit(\"handshake\"),this.pingTimer=setInterval(function(){t.send(\"ping\",137)},this.keepAlive),e=e.substring(e.indexOf(\"\\r\\n\\r\\n\")+4),this.connected=!0,this.emit(\"open\")),void(this.lastData=e);for(;e.length;){var o=2,i=15&e.charCodeAt(0),r=127&e.charCodeAt(1);if(126==r)r=e.charCodeAt(3)|e.charCodeAt(2)<<8,o+=2;else if(127==r)throw\"Messages > 65535 in length unsupported\";var n=r+o+(128&e.charCodeAt(1)?4:0);if(n>e.length)return void(this.lastData=e);switch(i){case 10:this.emit(\"pong\");break;case 9:this.send(\"pong\",138),this.emit(\"ping\");break;case 8:this.socket.end();break;case 0:case 1:var s=[0,0,0,0];128&e.charCodeAt(1)&&(s=[e.charCodeAt(o++),e.charCodeAt(o++),e.charCodeAt(o++),e.charCodeAt(o++)]);for(var a=\"\",h=0;h<r;h++)a+=String.fromCharCode(e.charCodeAt(o++)^s[3&h]);this.emit(\"message\",a);break;default:console.log(\"WS: Unknown opcode \"+i)}e=e.substr(n)}},WebSocket.prototype.handshake=function(){var e=[\"GET \"+this.path+\" HTTP/1.1\",\"Host: \"+this.host,\"Upgrade: websocket\",\"Connection: Upgrade\",\"Sec-WebSocket-Key: \"+this.key.source,\"Sec-WebSocket-Version: \"+this.protocolVersion,\"Origin: \"+this.origin];for(var t in this.protocol&&e.push(\"Sec-WebSocket-Protocol: \"+this.protocol),this.headers)this.headers.hasOwnProperty(t)&&e.push(t+\": \"+this.headers[t]);this.socket.write(e.join(\"\\r\\n\")+\"\\r\\n\\r\\n\")},WebSocket.prototype.send=function(e,t){t=void 0===t?129:t;var o=e.length;if(e.length>125&&(o=126),this.socket.write(String.fromCharCode(t,o+(this.masking?128:0))),126==o&&(this.socket.write(String.fromCharCode(e.length>>8)),this.socket.write(String.fromCharCode(e.length))),this.masking){for(var i=[],r=\"\",n=0;n<4;n++){var s=Math.floor(255*Math.random());i[n]=s,r+=String.fromCharCode(s)}for(var a=0;a<e.length;a++)r+=String.fromCharCode(e.charCodeAt(a)^i[3&a]);this.socket.write(r)}else this.socket.write(e)},WebSocket.prototype.close=function(){this.socket.end()},exports=function(e,t){var o=new WebSocket(e,t);return o.initializeConnection(),o},exports.createServer=function(e){var t=require(\"http\").createServer(function(o,i){if(o.headers.Connection&&o.headers.Connection.indexOf(\"Upgrade\")>=0){var r=o.headers[\"Sec-WebSocket-Key\"],n={Upgrade:\"websocket\",Connection:\"Upgrade\",\"Sec-WebSocket-Accept\":btoa(E.toString(require(\"crypto\").SHA1(r+\"258EAFA5-E914-47DA-95CA-C5AB0DC85B11\")))};o.headers[\"Sec-WebSocket-Protocol\"]&&(n[\"Sec-WebSocket-Protocol\"]=o.headers[\"Sec-WebSocket-Protocol\"]),i.writeHead(101,n);var s=new WebSocket(void 0,{masking:!1,connected:!0});s.socket=i,o.on(\"data\",s.parseData.bind(s)),o.on(\"close\",function(){clearInterval(s.srvPing),s.srvPing=void 0,s.emit(\"close\")}),s.srvPing=setInterval(function(){s.emit(\"ping\",!0),s.send(\"ping\",137)},s.keepAlive),t.emit(\"websocket\",s)}else e(o,i)});return t};");

require("Storage").write("httpPage", "<html><head>\r\n<title>{HOST_NAME}</title>\r\n<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\r\n</head><body>\r\n  <hr>\r\n  <div id=\"title\" style=\"text-align:center;color:magenta;\"></div>\r\n  <hr>\r\n  <textarea id=\"command\" style=\"width:100%;height:50px;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;\" autofocus></textarea>\r\n  <hr>\r\n  <div id=\"display\" style=\"width:100%;height:auto;overflow:auto;\"></div>\r\n  <script>\r\n    var hostname = document.title;\r\n    var command = document.getElementById(\"command\");\r\n    var display = document.getElementById(\"display\");\r\n\r\n    document.getElementById(\"title\").innerHTML = document.title;\r\n\r\n    command.onkeypress = function(k) {\r\n      if (k.keyCode === \"\\r\".charCodeAt()) { // New Line\r\n        k.preventDefault();\r\n        console.log(\"Command: \" + command.value);\r\n        printToDisplay(command.value, \"blue\");\r\n\r\n        var xmlhttp = new XMLHttpRequest();\r\n        xmlhttp.onload = function() {\r\n          console.log(\"Response: \" + this.responseText);\r\n          printToDisplay(this.responseText, \"green\");\r\n        };\r\n\r\n        xmlhttp.open(\"GET\", \"/command?eval=\" + command.value);\r\n        xmlhttp.send();\r\n        command.value = \"\";\r\n      } else if (k.keyCode === \"\\n\".charCodeAt()) { // Ctrl + Enter\r\n        k.preventDefault();\r\n        command.value += \"\\n\";\r\n      }\r\n    }\r\n\r\n    function printToDisplay(message, color) {\r\n      var pre = document.createElement(\"p\");\r\n      pre.style.color = color;\r\n      pre.style.wordWrap = \"break-word\";\r\n      pre.innerHTML = message.replace(/(?:\\r\\n|\\r|\\n)/g, \"<br />\") + \"<hr>\";\r\n      display.insertBefore(pre, display.firstChild);\r\n    }\r\n\r\n    function changeFavicon(src) {\r\n      var link = document.createElement(\"link\");\r\n      link.id = \"dynamic-favicon\";\r\n      link.rel = \"icon\";\r\n      link.href = src + \"?=\" + Date.now();\r\n\r\n      var oldLink = document.getElementById(\"dynamic-favicon\");\r\n      if (oldLink) {\r\n        document.head.removeChild(oldLink);\r\n      }\r\n\r\n      document.head.appendChild(link);\r\n    }\r\n\r\n    changeFavicon(\"favicon.ico\");\r\n  </script>\r\n</body></html>\r\n");

require("Storage").write("favicon", "\0\0\1\0\1\0\20\20\0\0\0\0 \0h\4\0\0\26\0\0\0(\0\0\0\20\0\0\0 \0\0\0\1\0 \0\0\0\0\0@\4\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\xff\xff\xff\1\xff\xff\xff\1\xff\xff\xff\1\xff\xff\xff\1\xdc\xbb\x961\xc7\xac\x91\x97\x95wY\xd9\x84eH\xf9\x83dF\xf9\x8dlL\xd9\xa4~X\x97\xc6\x9al1\xff\xff\xff\1\xff\xff\xff\1\xff\xff\xff\1\xff\xff\xff\1\xff\xff\xff\1\xff\xff\xff\1\xe2\xc0\x93\13\xdd\xc8\xb2\x99\xbe\xb2\xa7\xfdF<4\xff% \34\xff \35\33\xff!\36\34\xff(#\37\xff<1&\xfflS;\xfd\xa5\x7fY\x99\xcd\x9dh\13\xff\xff\xff\1\xff\xff\xff\1\xff\xff\xff\1\xe0\xc2\x99\13\xe1\xd3\xc3\xc1\xc8\xc2\xbe\xff^]\\\xff\25\25\24\xff\25\25\25\xff(((\xff+++\xff\30\30\30\xff\32\32\32\xff\" \35\xffG8+\xff\x99uR\xc1\xc9\x9bj\13\xff\xff\xff\1\xff\xff\xff\1\xe8\xda\xc9\x99\xd3\xcf\xcb\xff\xbe\xbe\xbe\xff'''\xff\22\22\22\xff%%%\xff\xbd\xbd\xbd\xff\x9d\x9d\x9d\xff,,,\xff\30\30\30\xff\31\31\31\xff\36\35\33\xffF7*\xff\xa2|W\x99\xff\xff\xff\1\xe9\xd4\xb81\xe4\xdf\xd9\xfd\xcf\xce\xce\xff\xc2\xc2\xc2\xff+++\xff\21\21\21\xff'''\xff\xd9\xd9\xd9\xff\xb9\xb9\xb9\xff---\xff\26\26\26\xff\27\27\27\xff\30\30\30\xff!\36\34\xffhO9\xfd\xbd\x93g1\xee\xe2\xd5\x97\xe0\xde\xdd\xff\xd3\xd3\xd3\xff\xca\xca\xca\xffOOO\xff\17\17\17\xff\20\20\20\xff,,,\xff///\xff\24\24\24\xff\25\25\25\xff\26\26\26\xff\27\27\27\xff\30\30\30\xff7-$\xff\x9cvQ\x97\xef\xe7\xde\xd9\xe2\xe2\xe1\xff\xd8\xd8\xd8\xff\xd0\xd0\xd0\xff\xad\xad\xad\xff\37\37\37\xff\16\16\16\xff\20\20\20\xff\21\21\21\xff\22\22\22\xff\23\23\23\xff\24\24\24\xff\25\25\25\xff\26\26\26\xff#\37\34\xff\x84cD\xd9\xf1\xea\xe3\xf9\xe6\xe6\xe6\xff\xde\xde\xde\xff\xd6\xd6\xd6\xff\xcd\xcd\xcd\xff\xad\xad\xad\xffLLL\xff\33\33\33\xff\25\25\25\xff\20\20\20\xff\21\21\21\xff\22\22\22\xff\24\24\24\xff\25\25\25\xff\34\32\30\xffxZ>\xf9\xf3\xed\xe6\xf9\xea\xeb\xea\xff\xe3\xe3\xe3\xff\xdb\xdb\xdb\xff\xd3\xd3\xd3\xff\xca\xca\xca\xff\xc1\xc1\xc1\xff\xb4\xb4\xb4\xff\xa6\xa6\xa6\xff\x84\x84\x84\xff333\xff\21\21\21\xff\22\22\22\xff\23\23\23\xff\32\30\26\xffwX<\xf9\xf5\xef\xe8\xd9\xef\xf0\xef\xff\xe8\xe8\xe8\xff\xe1\xe1\xe1\xff\xd8\xd8\xd8\xff\xd0\xd0\xd0\xff\xc7\xc7\xc7\xff\xbf\xbf\xbf\xff\xb6\xb6\xb6\xff\xae\xae\xae\xff\x9e\x9e\x9e\xff---\xff\20\20\20\xff\21\21\21\xff\36\32\27\xff\x7f^>\xd9\xf5\xed\xe2\x97\xf5\xf4\xf4\xff\xec\xec\xec\xff\xe6\xe6\xe6\xff\xde\xde\xde\xff\xd6\xd6\xd6\xff\xcd\xcd\xcd\xff\xb9\xb9\xb9\xff\xaf\xaf\xaf\xff\xb4\xb4\xb4\xff\xab\xab\xab\xff{{{\xff\17\17\17\xff\20\20\20\xff/%\33\xff\x94lF\x97\xec\xdb\xc31\xf9\xf7\xf5\xfd\xf1\xf1\xf1\xff\xea\xea\xea\xff\xe3\xe3\xe3\xff\xdb\xdb\xdb\xff\xc8\xc8\xc8\xff###\xff&&&\xff\xab\xab\xab\xff\xb1\xb1\xb1\xff\xa1\xa1\xa1\xff\30\30\30\xff\25\22\20\xff\\C+\xfd\xb5\x86Y1\xff\xff\xff\1\xf5\xed\xe2\x99\xf7\xf6\xf6\xff\xef\xef\xef\xff\xe8\xe8\xe8\xff\xe1\xe1\xe1\xff\xca\xca\xca\xff\30\30\30\xff\31\31\31\xff\xb1\xb1\xb1\xff\xb6\xb6\xb6\xff\xa8\xa8\xa8\xff\22\20\20\xff7(\33\xff\x95lE\x99\xff\xff\xff\1\xff\xff\xff\1\xde\xc3\x9f\13\xf7\xf1\xea\xc1\xf5\xf5\xf4\xff\xed\xed\xed\xff\xe6\xe6\xe6\xff\xde\xde\xde\xff\xc5\xc5\xc5\xff\xbb\xbb\xbb\xff\xc5\xc5\xc5\xff\xbc\xbc\xbc\xff\x90\x8f\x8d\xff5&\30\xff\x87_9\xc1\xd0\xa1p\13\xff\xff\xff\1\xff\xff\xff\1\xff\xff\xff\1\xe3\xc8\xa2\13\xf6\xee\xe5\x99\xf5\xf3\xf1\xfd\xed\xec\xeb\xff\xe4\xe4\xe4\xff\xdc\xdc\xdb\xff\xd4\xd4\xd3\xff\xcd\xcc\xcb\xff\xc3\xbf\xbc\xffv\\E\xfd\x90e;\x99\xbd\x87O\13\xff\xff\xff\1\xff\xff\xff\1\xff\xff\xff\1\xff\xff\xff\1\xff\xff\xff\1\xff\xff\xff\1\xf0\xe1\xce1\xf4\xec\xe4\x97\xf1\xea\xe4\xd9\xec\xe6\xe0\xf9\xe6\xde\xd6\xf9\xd9\xc9\xba\xd9\xb6\x96w\x97\xbc\x91f1\xff\xff\xff\1\xff\xff\xff\1\xff\xff\xff\1\xff\xff\xff\1\0\0\xff\xff\0\0\xff\xff\0\0\xff\xff\0\0\xff\xff\0\0\xff\xff\0\0\xff\xff\0\0\xff\xff\0\0\xff\xff\0\0\xff\xff\0\0\xff\xff\0\0\xff\xff\0\0\xff\xff\0\0\xff\xff\0\0\xff\xff\0\0\xff\xff\0\0\xff\xff");
