<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Remote Switch</title>
  </head>
<body style="margin: auto; display: table; position: absolute; width: 100%; height: 100%; background-color: black;">

<div style="display: table-cell; vertical-align: middle;">
  <div style="margin: auto; text-align: center; width: 200px; height: 400px; background-color: rgb(250, 250, 250); border: 5px solid rgb(150, 150, 150); border-radius: 10px;">
    <div style="width: 200px; height: 400px; background-color: rgb(50, 250, 50); opacity: 0.0;" id="statusResult"></div>
    <div style="left: -65px; top: -235px; width: 30px; height: 30px; position: relative; display: inline-block; font-size: 40px; color: rgb(50, 250, 50); opacity: 0.0;" id="statusUserStar">&#9733;</div>
    <div style="left: 65px; top: -235px; width: 30px; height: 30px; position: relative; display: inline-block; font-size: 40px; color: rgb(50, 250, 50); opacity: 0.0;" id="statusDeviceStar">&#9733;</div>
    <div style="top: -426px; position: relative;">
      <div style="width: 130px; height: 108px; display: inline-block; background: url('images/switchup.png') no-repeat;"></div>
      <div style="height: 15px;"></div>
      <div style="width: 130px; height: 108px; display: inline-block; background: url('images/switchstop.png') no-repeat;"></div>
      <div style="height: 15px;"></div>
      <div style="width: 130px; height: 108px; display: inline-block; background: url('images/switchdown.png') no-repeat;"></div>
    </div>
    <div style="top: -792px; position: relative;">
      <div style="width: 130px; height: 108px; display: inline-block; background-color: rgb(255, 255, 0); border-radius: 10px; opacity: 0.0;" id="switchUp"></div>
      <div style="height: 15px;"></div>
      <div style="width: 130px; height: 108px; display: inline-block; background-color: rgb(255, 0, 0); border-radius: 10px; opacity: 0.0;" id="switchStop"></div>
      <div style="height: 15px;"></div>
      <div style="width: 130px; height: 108px; display: inline-block; background-color: rgb(255, 255, 0); border-radius: 10px; opacity: 0.0;" id="switchDown"></div>
    </div>
  </div>
</div>

<script language="javascript" type="text/javascript">

const USER_NAME = "IOT_USER";
const USER_PASSWORD = "none";
const DEVICE_NAME = window.location.pathname.split("/").pop().split(".").shift();
const SERVER_URL = "ws://achex.ca:4010";

var switchUp;
var switchStop;
var switchDown;
var statusUser;
var statusDevice;
var statusUserStar;
var statusDeviceStar;
var statusResult;
var token;
var websocket;
var sid;

function init() {
  changeFavicon("favicon.ico");

  switchUp = document.getElementById("switchUp");
  switchStop = document.getElementById("switchStop");
  switchDown = document.getElementById("switchDown");
  statusUserStar = document.getElementById("statusUserStar");
  statusDeviceStar = document.getElementById("statusDeviceStar");
  statusResult = document.getElementById("statusResult");

  switchUp.onclick = onSwitchUp;
  switchStop.onclick = onSwitchStop;
  switchDown.onclick = onSwitchDown;

  var cookies = parseCookies();

  if (!cookies.token) {
    token = prompt("กำหนดรหัสความปลอดภัย");

    if (token) {
      var now = new Date();
      now.setFullYear(now.getFullYear() + 1);
      document.cookie = "token=" + token + "; expires=" + now.toUTCString() + ";";
    } else {
      deleteCookie("token");
    }
  } else {
    token = cookies.token;
  }

  send({ "auth": "ok" });
}

function parseCookies(cookie) {
  var list = {};
  var cookies = cookie || document.cookie;

  cookies && cookies.split(";").forEach(function(cookie) {
    var parts = cookie.split("=");
    list[parts.shift().trim()] = decodeURI(parts.join("="));
  });

  return list;
}

function mergeCookies(list) {
  var cookies = [];

  for (var i in list) {
    cookies.push([i + "=" + list[i]]);
  }

  return cookies.join("; ");
}

function deleteCookie(name) {
  document.cookie = name + "=; expires=Thu, 01 Jan 1970 00:00:01 GMT;";
}

function connect(message) {
  if (typeof(websocket) !== "undefined") {
    delete websocket;
  }

  websocket = new WebSocket(SERVER_URL);
  websocket.onopen = function(event) { onOpen(event) };
  websocket.onclose = function(event) { onClose(event) };
  websocket.onmessage = function(event) { onMessage(event) };
  websocket.onerror = function(event) { onError(event) };
  websocket.message = message;
}

function send(message) {
  if (typeof(websocket) === "undefined" || websocket.readyState === WebSocket.CLOSED) {
    connect(message);
  } else {
    if (typeof(message) === "string") {
      message = { "message": message };
    }

    message.to = DEVICE_NAME;
    message.token = token;
    message = JSON.stringify(message);
    console.log("SEND:", message);
    websocket.send(message);
  }
}

function onOpen(event) {
  console.log("STATUS:", "CONNECTED");
  statusUser = false;
  statusDevice = false;
  statusUserStar.style.opacity = 0.0;
  statusDeviceStar.style.opacity = 0.0;
}

function onClose(event) {
  console.log("STATUS:", "DISCONNECTED");
  statusUser = false;
  statusDevice = false;
  statusUserStar.style.opacity = 0.0;
  statusDeviceStar.style.opacity = 0.0;
}

function onMessage(event) {
  console.log("MESSAGE:", event.data);
  var msgJSON = JSON.parse(event.data);

  if (msgJSON.SID){
    sid = msgJSON.SID;
    websocket.send(JSON.stringify({ "setID": USER_NAME, "passwd": USER_PASSWORD }));
  } else if (msgJSON.auth === "ok") {
    statusUser = true;
    statusUserStar.style.opacity = 1.0;

    if (websocket.message) {
      send(websocket.message);
      delete websocket.message;
    }
  } else if (msgJSON.device === "ONLINE") {
    statusDevice = true;
    statusDeviceStar.style.opacity = 1.0;
  } else if (msgJSON.device === "OFFLINE") {
    statusDevice = false;
    statusDeviceStar.style.opacity = 0.0;
  } else if (msgJSON.message) {
    console.log("MESSAGE:", msgJSON.message);

    if (msgJSON.message.startsWith("SWITCH_")) {
      fadeOut(statusResult);
    }
  } else if (msgJSON.error) {
    console.log("ERROR:", msgJSON.error);
  }
}

function onError(event) {
  console.log("ERROR:", event);
}

function onSwitchUp() {
  send({ "device": "console.log('SWITCH_UP'); 'SWITCH_UP'" });
  //send({ "device": "console.log('SWITCH_UP'); digitalPulse(NodeMCU.D1, LOW, [200]); 'SWITCH_UP'" });
  fadeOut(switchUp);
}

function onSwitchStop() {
  send({ "device": "console.log('SWITCH_STOP'); 'SWITCH_STOP'" });
  //send({ "device": "console.log('SWITCH_STOP'); digitalPulse(NodeMCU.D2, LOW, [200]); 'SWITCH_STOP'" });
  fadeOut(switchStop);
}

function onSwitchDown() {
  send({ "device": "console.log('SWITCH_DOWN'); 'SWITCH_DOWN'" });
  //send({ "device": "console.log('SWITCH_DOWN'); digitalPulse(NodeMCU.D5, LOW, [200]); 'SWITCH_DOWN'" });
  fadeOut(switchDown);
}

function fadeOut(element) {
  element.style.opacity = 1.0;

  var timer = setInterval(function() {
    if (element.style.opacity <= 0.1) {
      clearInterval(timer);
    }

    element.style.opacity -= 0.1;
  }, 100);
}

function changeFavicon(src) {
  var link = document.createElement("link");
  link.id = "dynamic-favicon";
  link.rel = "icon";
  link.href = src + "?=" + Date.now();

  var oldLink = document.getElementById("dynamic-favicon");
  if (oldLink) {
    document.head.removeChild(oldLink);
  }

  document.head.appendChild(link);
}

window.addEventListener("load", init, false);

</script>

</body>

</html>
